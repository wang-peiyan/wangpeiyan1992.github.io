<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css">
<script src="http://code.jquery.com/jquery-2.2.4.min.js"  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
<script src="/js/SimpleCore.js" type="text/javascript"></script>
<!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/warn.html"><![endif]-->

<title>CGI FastCGI PHP-FPM Nginx之间的关系</title>
<meta name="author" content="Penny">

<meta name="keywords" content="undefined">

<meta name="description " content="Monkey">

<link rel="icon" href="/images/favicon.png">

<link rel="stylesheet" href="/css/style.css">

  </head>
  <body>
    <aside id="sidebar">
  <nav id="tags">
    <a href="http://shuoit.net" id="avatar" style="background-image:url(/images/favicon.png)"></a>
    <ul id="tags__ul">
      <li id="pl__all" class="tags__li tags-btn active">所有文章</li>
      
      <li id="Git" class="tags__li tags-btn">Git</li>
      
      <li id="Markdown" class="tags__li tags-btn">Markdown</li>
      
      <li id="git博客" class="tags__li tags-btn">git博客</li>
      
      <li id="Nginx" class="tags__li tags-btn">Nginx</li>
      
    </ul>
    <div id="tags__bottom">
      <a href="http://github.com/tangkunyin" rel="nofollow" id="icon-github" target="_blank" class="tags-btn fontello"></a>
      <a href="http://shang.qq.com/wpa/qunwpa?idkey=6dc2741479cd031cc533fe5080081df44d0f9d95bc5083e8e1244c92f4aae218" rel="nofollow" id="icon-qq" target="_blank" class="tags-btn fontello"></a>
    </div>
  </nav> <!-- end #tags -->
  <div id="posts-list">
    <form action="#" id="search-form" target="_blank">
      <a href="/" id="mobile-avatar" style="background-image:url(/images/favicon.png)"></a>
      <input id="search-input" type="text" placeholder="戳一下不会怀孕" />
    </form>
    <nav id="pl__container">
      
            
                <a class="Git pl__all" href="/2016/09/29/gitblog/" title="Git博客配置">
                  <span class="pl__circle"></span><span class="pl__title">Git博客配置</span><span class="pl__date">2016-09-29</span>
                </a>
            
      
            
                <a class="Markdown pl__all" href="/2016/08/27/markdown/" title="Markdown标记语言学习">
                  <span class="pl__circle"></span><span class="pl__title">Markdown标记语言学习</span><span class="pl__date">2016-08-27</span>
                </a>
            
      
            
                <a class="git博客 pl__all" href="/2016/08/17/my-second-blog/" title="come on git博客！">
                  <span class="pl__circle"></span><span class="pl__title">come on git博客！</span><span class="pl__date">2016-08-17</span>
                </a>
            
      
            
                <a class="Nginx pl__all" href="/2016/11/20/php-nginx/" title="CGI FastCGI PHP-FPM Nginx之间的关系">
                  <span class="pl__circle"></span><span class="pl__title">CGI FastCGI PHP-FPM Nginx之间的关系</span><span class="pl__date">2016-11-20</span>
                </a>
            
      
    </nav>
  </div> <!-- end #posts-list -->
</aside> <!-- end #sidebar -->

    <div id="post">
      <div id="pjax">
        <article id="post__content">
  <h1 id="post__title" data-identifier="2016-11-20">CGI FastCGI PHP-FPM Nginx之间的关系</h1>
  <h1 id="CGI-FastCGI-PHP-FPM-PHP-CGI-Nginx之间的关系"><a href="#CGI-FastCGI-PHP-FPM-PHP-CGI-Nginx之间的关系" class="headerlink" title="CGI FastCGI PHP-FPM PHP-CGI Nginx之间的关系"></a>CGI FastCGI PHP-FPM PHP-CGI Nginx之间的关系</h1><p>首先我们先了解以下几个概念？它们都是什么？才能更好的知道它们之间有什么关系？</p>
<ul>
<li>CGI通信协议</li>
<li>FastCGI</li>
<li>PHP-CGI</li>
<li>PHP-FPM</li>
<li>web服务器</li>
<li>进程、主进程（master）、子进程（worker）</li>
<li>PHP解析器</li>
</ul>
<h2 id="CGI是什么？"><a href="#CGI是什么？" class="headerlink" title="CGI是什么？"></a>CGI是什么？</h2><p>CGI(Common Gateway Interface)通用网关接口，web服务器和脚本语言通信的一个标准接口、一种规范、一种协议［协议］</p>
<h2 id="FastCGI是什么？以及它的工作原理"><a href="#FastCGI是什么？以及它的工作原理" class="headerlink" title="FastCGI是什么？以及它的工作原理"></a>FastCGI是什么？以及它的工作原理</h2><p>CGI的升级版［协议］<br>FastCGI是基于CGI架构的扩展，它的核心思想就是在webserver和具体CGI程序之间建立一个智能的可持续的中间层，统管CGI程序的运行，这样webserver只需要将请求提交给这个层，这个层再派生出几个可复用的CGI程序实例，然后再把请求分发给这些实例，这些实例是可控的，可持续 可复用的，因此一方面避免了进程反复fork，另一方面又可以通过中间层的控制和探测机制来监视这些实例的运行情况，根据不同的状况fork或者回收实例，达到灵活性和稳定性兼得的目的。</p>
<p>特点：</p>
<ul>
<li>FastCGI采用C/S结构，可以将web服务器和动态脚本解析服务器分离（二者可以部署在不同的服务器上），让web服务器专一处理静态请求和转发动态请求到脚本解析服务器；脚本解析服务器则专一处理动态脚本的请求</li>
<li>FastCGI技术目前支持语言有：C/C++ 、java、Perl、Tcl、Python、SmallTalk、Ruby等。相关模块在Apache、IIS、Lighttpd等流行的服务器上也是可用的</li>
<li>FastCGI不依赖于任何Web服务器的内部架构，因此即使服务器技术的变化，FastCGI依然稳定不变</li>
<li>因为是多进程，所以比CGI线程消耗更多的服务器内存，PHP-CGI解析起每进程消耗7至25兆内存，将这个数字乘以50或100就是很大的内存数</li>
</ul>
<h2 id="PHP-CGI"><a href="#PHP-CGI" class="headerlink" title="PHP-CGI"></a>PHP-CGI</h2><p>实现了CGI接口协议的PHP脚本解析器［程序］</p>
<p>特点：</p>
<ul>
<li>PHP-CGI变更PHP.ini配置后需重启PHP-CGI才能让新的php.ini生效，不可以平滑重启</li>
<li>直接杀死PHP-CGI进程，PHP就不能运行了。</li>
</ul>
<h2 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h2><p>PHP-FPM是管理和调度PHP-CGI进程，进而实现FastCGI接口协议的程序，被PHP官方收购 在5.2之前属于PHP的扩展和补丁，5.3以后就集成在PHP的内核中。［程序］</p>
<p>特点：</p>
<ul>
<li>PHP-FPM提供了更好的PHP进程管理方式，可以有效控制内存和进程、可以平滑重载PHP配置。在./configure的时候–enable-fpm 参数即可开启PHP-FPM</li>
</ul>
<h2 id="web服务器"><a href="#web服务器" class="headerlink" title="web服务器"></a>web服务器</h2><p>webserver（Nginx Apache IIs ）只能处理静态文件，对于PHP这样的动态脚本无能为力，只能交给PHP自己来处理于是有了下面这个流程：</p>
<ul>
<li>服务器（webserver）－－－协议（CGI通信）－－－ 程序（PHP-CGI）－－－ 脚本（PHP）</li>
<li>服务器（webserver）－－－协议（FastCGI通信）－－－ PHP-FPM －－－ 程序（PHP-CGI多个）－－－ 脚本（PHP）</li>
</ul>
<blockquote>
<p>第一种：架构上有个性能问题，CGI对每个请求回parse一遍对应脚本的配置文件（如PHP.ini）,加载配置和扩展，初始化执行环境，性能非常差，所以有了第二种流程</p>
<p>第二种：那么实现FastCGI协议的程序，如PHP-FPM是什么角色呢？FastCGI会先启动一个master程序，解析配置文件，初始化执行环境，然后在启动多个worker进程，这个worker就是PHP-CGI，当请求过来时，master会传递给一个worker，然后立即可以接受下一个请求，这样就避免了重复的劳动，效率自然是高，而去当worker不够用时，master可以根据配置预先启动几个worker等着，比如20worker，当然空闲的worker 太多时，也会停掉一些，这样就提高来性能，也解约了资源，这就是FastCGI对进程的管理。最大的worker进程数时128</p>
</blockquote>
<h2 id="Apache-Nginx与PHP的通信方式"><a href="#Apache-Nginx与PHP的通信方式" class="headerlink" title="Apache Nginx与PHP的通信方式"></a>Apache Nginx与PHP的通信方式</h2><p>PHP-FPM作为一个独立的进程存在，通过socket与Nginx建立连接，而mod_PHP时作为一个模块被加载进了Apache服务器，同时他们两作为CGI调度管理器，他们对其管理的方式也不一样。mod_PHP这种嵌入的方式最大的弊端就是内存占用大，不论是否用到PHP解析器都会将其加载到内存中，典型的就是处理CSS、JS之类的静态文件时完全没有必要加载解析器</p>

</article>
<button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

  <div id="post__action">
      <a id="icon-heart" class="fontello" href="javascript:donate();"></a>
  </div>
  <script src="/layer/layer.js" type="text/javascript"></script>
  <script src="/layer/extend/layer.ext.js" type="text/javascript"></script>


<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="undefined" data-title="CGI FastCGI PHP-FPM Nginx之间的关系" data-url="http://shuoit.net/2016/11/20/php-nginx/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"shuoit"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

        <p id="copyright">由<a href="http://hexo.io" target="_blank">Hexo</a>创建&nbsp;&nbsp;|&nbsp;&nbsp;主题<a href="https://github.com/tangkunyin/hexo-theme-simple" target="_blank">Simple</a>&nbsp;&nbsp;|&nbsp;&nbsp;感谢<a href="https://coding.net/register?key=bcace447-fa41-4579-9783-86fdf0f723e2" target="_blank">Coding</a>提供强力驱动</p>
<!-- 百度统计 -->
<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?a01595b492af7e4a793230e3d49ae638";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

      </div>
      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">目录</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div>
  </body>
</html>
